<ion-header class="jars-header" translucent="true">
  <ion-toolbar>
    <ion-title>My Budgets</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" class="icon-button">
        <ion-icon name="search-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="icon-button avatar-button">
        <ion-icon name="person-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="jars-page" fullscreen="true">
  <div class="page-inner">
    <section class="total-card">
      <div class="total-label">TOTAL SAVED</div>
      <div class="total-amount">
        <span class="currency">₫</span>
        <span class="value">{{ totalSavedMain }}</span>
        <span class="cents">.{{ totalSavedCents }}</span>
      </div>
      <div class="total-trend">
        <ion-icon name="trending-up-outline"></ion-icon>
        <span>+12.5% from last month</span>
      </div>
    </section>

    <div class="section-title">ACTIVE BUDGETS</div>

    <div class="loading-state" *ngIf="isLoadingJars">
      <ion-spinner name="crescent"></ion-spinner>
      <span>Loading budgets...</span>
    </div>

    <section class="jars-list" *ngIf="!isLoadingJars">
      <article class="jar-card" *ngFor="let jar of jars" (click)="navigateToJar(jar.id)">
        <div class="jar-icon" [ngClass]="getJarIconClass(jar)">
          <ion-icon [name]="getJarIcon(jar)"></ion-icon>
        </div>
        <div class="jar-info">
          <div class="jar-top-row">
            <div class="jar-title-group">
              <div class="jar-title">{{ jar.name }}</div>
            </div>
            <div class="jar-amount-group">
              <div class="jar-amount">{{ formatCurrency(getJarDisplayAmount(jar)) }}</div>
              <div class="jar-left" [class.jar-left--overspent]="isJarOverspent(jar)">
                <ng-container *ngIf="isJarOverspent(jar); else leftLabel">
                  Overspent {{ getJarOverspent(jar) | number:'1.0-0' }}
                </ng-container>
                <ng-template #leftLabel>
                  Left {{ getJarRemaining(jar) | number:'1.0-0' }}
                </ng-template>
              </div>
            </div>
          </div>
          <div class="jar-bottom-row">
            <div class="jar-percent">{{ getJarProgress(jar) }}%</div>
          </div>
          <div class="progress-track">
            <div
              class="progress-fill"
              [style.width.%]="getJarProgress(jar)"
            ></div>
          </div>
        </div>
      </article>
    </section>
  </div>
</ion-content>

<ion-modal
  [isOpen]="isCreateJarOpen"
  (didDismiss)="closeCreateJar()"
  class="transaction-modal"
>
  <ng-template>
    <ion-header class="transaction-header">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button fill="clear" (click)="closeCreateJar()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add Budget</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="transaction-page">
      <form (ngSubmit)="submitCreateJar()">
        <ion-card class="section-card">
          <div class="section-title">Budget Details</div>

          <div class="field">
            <div class="field-label">CATEGORY</div>
            <ion-item lines="none" class="text-item">
              <ion-select
                interface="action-sheet"
                [interfaceOptions]="categorySelectInterfaceOptions"
                placeholder="Select category or sub category"
                [(ngModel)]="selectedBudgetCategoryValue"
                name="selectedBudgetCategoryValue"
                required
              >
                <ion-select-option
                  *ngFor="let option of budgetCategoryOptions"
                  [value]="option.value"
              >
                  {{ option.treeLabel }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>

          <div class="field">
            <div class="field-label">AMOUNT</div>
            <div class="amount-block">
              <div class="amount-input-row">
                <div class="currency">₫</div>
                <ion-input
                  type="text"
                  inputmode="numeric"
                  placeholder="0"
                  [(ngModel)]="budgetAmount"
                  (ngModelChange)="onBudgetAmountChange($event)"
                  (ionBlur)="onBudgetAmountBlur()"
                  name="budgetAmount"
                  required
                ></ion-input>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="field-label">DATE</div>
            <ion-item lines="none" class="text-item">
              <ion-select
                interface="action-sheet"
                [(ngModel)]="budgetPeriod"
                name="budgetPeriod"
                [placeholder]="selectedPeriodLabel"
              >
                <ion-select-option
                  *ngFor="let period of budgetPeriodOptions"
                  [value]="period"
                >
                  {{ getPeriodOptionLabel(period) }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>
        </ion-card>

        <ion-card class="receipt-card">
          <ion-item lines="none">
            <ion-label>Repeat this budget</ion-label>
            <ion-toggle slot="end" [(ngModel)]="repeatThisBudget" name="repeatThisBudget"></ion-toggle>
          </ion-item>
        </ion-card>

        <ion-button
          expand="block"
          class="save-button"
          type="submit"
          [disabled]="!canSaveJar"
        >
          Save Budget
        </ion-button>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
