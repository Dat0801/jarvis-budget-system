<ion-header class="jar-detail-header" translucent="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="goBack()">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Budget details</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" class="header-icon-btn" (click)="openEditJar()" aria-label="Edit budget">
        <ion-icon name="create-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="header-icon-btn" (click)="confirmDeleteJar()" aria-label="Delete budget">
        <ion-icon name="trash-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="jar-detail-page" fullscreen="true">
  <div class="page-inner">
    <ng-container *ngIf="!isLoadingJar; else jarLoading">
      <section class="balance-card">
        <div class="budget-category-row">
          <div class="jar-icon-large">
            <ion-icon name="basket-outline"></ion-icon>
          </div>
          <div class="budget-category-name">{{ jar?.category || jar?.name }}</div>
        </div>

        <div class="progress-section">
          <div class="progress-top-info">
            <div class="progress-stat spent">
              <div class="progress-label">Spent</div>
              <div class="progress-value">{{ formatCurrency(getSpentAmount()) }}</div>
            </div>
            <div class="progress-stat left" [class.progress-stat--overspent]="isOverspent()">
              <div class="progress-label">{{ isOverspent() ? 'Overspent' : 'Left' }}</div>
              <div class="progress-value">{{ formatCurrency(isOverspent() ? getOverspentAmount() : getLeftAmount()) }}</div>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="getSpentPercentage()"></div>
          </div>

          <div class="progress-date">
            <div class="progress-date-main">
              <ion-icon name="calendar-outline"></ion-icon>
              <span>{{ getBudgetDateRangeDisplay() }}</span>
            </div>
            <div class="progress-days-left">{{ getBudgetDaysLeft() }} days left</div>
          </div>
        </div>
      </section>
    </ng-container>
    <ng-template #jarLoading>
      <div class="loading-state">
        <ion-spinner name="crescent"></ion-spinner>
        <span>Loading budget...</span>
      </div>
    </ng-template>

    <!-- Recent Activity Section -->
    <div class="loading-state" *ngIf="isLoadingTransactions">
      <ion-spinner name="crescent"></ion-spinner>
      <span>Loading transactions...</span>
    </div>

    <section class="activity-section" *ngIf="!isLoadingTransactions && transactions.length > 0">
      <div class="section-header">
        <h3 class="section-title">Recent Activity</h3>
        <a href="#" class="see-all-link" (click)="seeAllTransactions(); $event.preventDefault()">See All</a>
      </div>

      <div class="activity-list">
        <article class="activity-item" *ngFor="let transaction of getRecentTransactions()">
          <div class="activity-icon" [ngClass]="'icon-' + getTransactionColor(transaction)">
            <ion-icon [name]="getTransactionIcon(transaction)"></ion-icon>
          </div>
          <div class="activity-info">
            <div class="activity-title">
              {{ transaction.note || transaction.source || transaction.category || 'Transaction' }}
            </div>
            <div class="activity-date">{{ getFormattedDate(transaction.created_at) }}</div>
          </div>
          <div class="activity-amount" [ngClass]="'amount-' + getTransactionColor(transaction)">
            <span *ngIf="transaction.type === 'expense'" class="sign">-</span><span
              *ngIf="transaction.type === 'income'"
              class="sign"
              >+</span
            >
            {{ formatCurrency(transaction.amount) }}
          </div>
        </article>
      </div>
    </section>

    <!-- Spending Insights Section -->
    <section class="insights-section" *ngIf="jar?.avgDailySpend !== undefined">
      <div class="insights-card">
        <div class="insights-header">
          <ion-icon name="stats-chart-outline"></ion-icon>
          <h3>Spending Insights</h3>
        </div>

        <div class="insights-grid">
          <div class="insight-item">
            <div class="insight-label">AVG. DAILY SPEND</div>
            <div class="insight-value">{{ formatCurrency(jar?.avgDailySpend || 0) }}</div>
          </div>
          <div class="insight-item">
            <div class="insight-label">CYCLE REMAINING</div>
            <div class="insight-value">{{ jar?.cycleRemaining || 12 }} Days</div>
          </div>
        </div>

        <div class="insights-message">
          <p>"You're spending 15% less than last month. Great job!"</p>
        </div>
      </div>
    </section>
  </div>
</ion-content>

<!-- Add Money Modal -->
<ion-modal [isOpen]="isAddMoneyOpen" (didDismiss)="closeAddMoney()" class="transaction-modal">
  <ng-template>
    <ion-header class="transaction-header">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button fill="clear" (click)="closeAddMoney()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add Money</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="transaction-page">
      <form (ngSubmit)="submitAddMoney()">
        <div class="amount-block">
          <div class="amount-label">AMOUNT</div>
          <div class="amount-input-row">
            <div class="currency">đ</div>
            <ion-input
              type="text"
              inputmode="numeric"
              placeholder="0"
              [(ngModel)]="addAmount"
              (ionInput)="onAddAmountInput($event)"
              name="addAmount"
            ></ion-input>
          </div>
        </div>

        <div class="form-actions">
          <ion-button fill="clear" (click)="closeAddMoney()" expand="block">Cancel</ion-button>
          <ion-button type="submit" expand="block" [disabled]="!canSubmitAddMoney">
            Add Money
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Edit Budget Modal -->
<ion-modal [isOpen]="isEditJarOpen" (didDismiss)="closeEditJar()" class="transaction-modal edit-budget-modal">
  <ng-template>
    <ion-header class="transaction-header">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button fill="clear" (click)="closeEditJar()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Budget</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="transaction-page">
      <form (ngSubmit)="submitEditJar()">
        <ion-card class="section-card">
          <div class="section-title">Budget Details</div>

          <div class="field">
            <div class="field-label">CATEGORY</div>
            <ion-item
              lines="none"
              class="text-item"
              button
              detail="false"
              (click)="openCategorySelector()"
            >
              <ion-label>{{ selectedBudgetCategoryLabel || 'Select category' }}</ion-label>
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-item>
          </div>

          <div class="field">
            <div class="field-label">AMOUNT</div>
            <div class="amount-block">
              <div class="amount-input-row">
                <div class="currency">đ</div>
                <ion-input
                  type="text"
                  inputmode="numeric"
                  placeholder="0"
                  [(ngModel)]="editBudgetAmount"
                  (ngModelChange)="onEditBudgetAmountChange($event)"
                  (ionBlur)="onEditBudgetAmountBlur()"
                  name="editBudgetAmount"
                  required
                ></ion-input>
              </div>
            </div>
          </div>

          <div class="field">
            <div class="field-label">DATE</div>
            <ion-item lines="none" class="text-item">
              <ion-select
                interface="action-sheet"
                [(ngModel)]="editBudgetPeriod"
                name="editBudgetPeriod"
                [placeholder]="selectedPeriodLabel"
              >
                <ion-select-option
                  *ngFor="let period of budgetPeriodOptions"
                  [value]="period"
                >
                  {{ getPeriodOptionLabel(period) }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </div>
        </ion-card>

        <ion-card class="receipt-card">
          <ion-item lines="none">
            <ion-label>Repeat this budget</ion-label>
            <ion-toggle slot="end" [(ngModel)]="editRepeatThisBudget" name="editRepeatThisBudget"></ion-toggle>
          </ion-item>
        </ion-card>

        <ion-button
          expand="block"
          class="save-button"
          type="submit"
          [disabled]="!canUpdateJar"
        >
          Update Budget
        </ion-button>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
