<ion-header class="jar-detail-header" translucent="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="goBack()">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>{{ jar?.name }}</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" class="icon-button">
        <ion-icon name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="jar-detail-page" fullscreen="true">
  <div class="page-inner">
    <!-- Budget Balance Card -->
    <section class="balance-card">
      <div class="jar-icon-large">
        <ion-icon name="basket-outline"></ion-icon>
      </div>

      <div class="balance-section">
        <div class="balance-label">AVAILABLE BALANCE</div>
        <div class="balance-amount">
          <span class="currency">₫</span>
          <span class="value">{{ formatCurrency(jar?.balance || 0) }}</span>
        </div>
        <div class="target-label">Target: ₫{{ jar?.target | number: '1.0-0' }}</div>
      </div>

      <div class="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="getProgress()"></div>
        </div>
        <div class="progress-info">
          <span class="progress-percent">{{ getProgress() | number: '1.0-0' }}% Saved</span>
          <span class="remaining">₫{{ formatCurrency(getRemaining()) }} left</span>
        </div>
      </div>
    </section>

    <!-- Action Buttons -->
    <section class="action-buttons">
      <ion-button expand="block" class="add-money-btn" (click)="openAddMoney()">
        <ion-icon name="add-circle" slot="start"></ion-icon>
        Add Money
      </ion-button>
      <ion-button expand="block" fill="outline" class="edit-jar-btn" (click)="openEditJar()">
        <ion-icon name="pencil" slot="start"></ion-icon>
        Edit Budget
      </ion-button>
    </section>

    <!-- Recent Activity Section -->
    <section class="activity-section" *ngIf="transactions.length > 0">
      <div class="section-header">
        <h3 class="section-title">Recent Activity</h3>
        <a href="#" class="see-all-link" (click)="seeAllTransactions(); $event.preventDefault()">See All</a>
      </div>

      <div class="activity-list">
        <article class="activity-item" *ngFor="let transaction of getRecentTransactions()">
          <div class="activity-icon" [ngClass]="'icon-' + getTransactionColor(transaction)">
            <ion-icon [name]="getTransactionIcon(transaction)"></ion-icon>
          </div>
          <div class="activity-info">
            <div class="activity-title">
              {{ transaction.note || transaction.source || transaction.category || 'Transaction' }}
            </div>
            <div class="activity-date">{{ getFormattedDate(transaction.created_at) }}</div>
          </div>
          <div class="activity-amount" [ngClass]="'amount-' + getTransactionColor(transaction)">
            <span *ngIf="transaction.type === 'expense'" class="sign">-</span><span
              *ngIf="transaction.type === 'income'"
              class="sign"
              >+</span
            >
            ₫{{ formatCurrency(transaction.amount) }}
          </div>
        </article>
      </div>
    </section>

    <!-- Spending Insights Section -->
    <section class="insights-section" *ngIf="jar?.avgDailySpend !== undefined">
      <div class="insights-card">
        <div class="insights-header">
          <ion-icon name="stats-chart-outline"></ion-icon>
          <h3>Spending Insights</h3>
        </div>

        <div class="insights-grid">
          <div class="insight-item">
            <div class="insight-label">AVG. DAILY SPEND</div>
            <div class="insight-value">₫{{ formatCurrency(jar?.avgDailySpend || 0) }}</div>
          </div>
          <div class="insight-item">
            <div class="insight-label">CYCLE REMAINING</div>
            <div class="insight-value">{{ jar?.cycleRemaining || 12 }} Days</div>
          </div>
        </div>

        <div class="insights-message">
          <p>"You're spending 15% less than last month. Great job!"</p>
        </div>
      </div>
    </section>
  </div>
</ion-content>

<!-- Add Money Modal -->
<ion-modal [isOpen]="isAddMoneyOpen" (didDismiss)="closeAddMoney()" class="transaction-modal">
  <ng-template>
    <ion-header class="transaction-header">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button fill="clear" (click)="closeAddMoney()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Add Money</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="transaction-page">
      <form (ngSubmit)="submitAddMoney()">
        <div class="amount-block">
          <div class="amount-label">AMOUNT</div>
          <div class="amount-input-row">
            <div class="currency">₫</div>
            <ion-input
              type="text"
              inputmode="numeric"
              placeholder="0"
              [(ngModel)]="addAmount"
              (ionInput)="onAddAmountInput($event)"
              name="addAmount"
            ></ion-input>
          </div>
        </div>

        <div class="form-actions">
          <ion-button fill="clear" (click)="closeAddMoney()" expand="block">Cancel</ion-button>
          <ion-button type="submit" expand="block" [disabled]="!canSubmitAddMoney">
            Add Money
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Edit Budget Modal -->
<ion-modal [isOpen]="isEditJarOpen" (didDismiss)="closeEditJar()" class="transaction-modal">
  <ng-template>
    <ion-header class="transaction-header">
      <ion-toolbar>
        <ion-buttons slot="start">
          <ion-button fill="clear" (click)="closeEditJar()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Edit Budget</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content class="transaction-page">
      <form (ngSubmit)="submitEditJar()">
        <div class="form-group">
          <label>Budget Name</label>
          <ion-input
            type="text"
            placeholder="Enter budget name"
            [(ngModel)]="editName"
            name="editName"
          ></ion-input>
        </div>

        <div class="form-group">
          <label>Description</label>
          <ion-textarea
            placeholder="Enter jar description"
            [(ngModel)]="editDescription"
            name="editDescription"
            rows="4"
          ></ion-textarea>
        </div>

        <div class="form-actions">
          <ion-button fill="clear" (click)="closeEditJar()" expand="block">Cancel</ion-button>
          <ion-button type="submit" expand="block" [disabled]="!editName">Update Budget</ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
