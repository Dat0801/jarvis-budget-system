<ion-header [translucent]="true" class="transaction-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button fill="clear" routerLink="/tabs/dashboard" aria-label="Back to Home">
        <ion-icon name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Transactions</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" aria-label="Search transactions">
        <ion-icon name="search-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="transaction-content" [fullscreen]="false">
  <section class="summary-card" *ngIf="!isLoading && !error">
    <div class="summary-head">
      <div>
        <p class="summary-label">Total Balance</p>
        <h2>{{ formatSignedCurrency(totalBalance) }}</h2>
        <p class="summary-delta" [class.positive]="monthDeltaPercent >= 0" [class.negative]="monthDeltaPercent < 0">
          {{ monthDeltaPercent >= 0 ? '↗' : '↘' }}
          {{ monthDeltaPercent >= 0 ? '+' : '' }}{{ monthDeltaPercent }}% vs last month
        </p>
      </div>
      <ion-button size="small" (click)="openReportsModal()">View Report</ion-button>
    </div>

    <div class="summary-grid">
      <article class="summary-item inflow">
        <p>↓ INFLOW</p>
        <h3>{{ formatCurrency(inflowTotal) }}</h3>
      </article>
      <article class="summary-item outflow">
        <p>↑ OUTFLOW</p>
        <h3>{{ formatCurrency(outflowTotal) }}</h3>
      </article>
    </div>
  </section>

  <div class="state-wrap" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
  </div>

  <ion-card color="danger" *ngIf="error">
    <ion-card-content>{{ error }}</ion-card-content>
  </ion-card>

  <section class="transactions-list" *ngIf="!isLoading && !error">
    <ng-container *ngFor="let group of groupedTransactions; trackBy: trackByGroup">
      <ion-list lines="none">
        <ion-item *ngFor="let transaction of group.items; trackBy: trackByTransaction">
          <div
            slot="start"
            class="icon-box"
            [class.income]="transaction.type === 'income'"
            [class.expense]="transaction.type === 'expense'"
          >
            <ion-icon [name]="transaction.icon"></ion-icon>
          </div>

          <ion-label>
            <h3>{{ transaction.title }}</h3>
            <p>{{ transaction.subtitle }}</p>
          </ion-label>

          <p
            class="amount"
            [class.income]="transaction.type === 'income'"
            [class.expense]="transaction.type === 'expense'"
            [style.color]="transaction.type === 'income' ? '#16a34a' : '#e23a3d'"
          >
            <span class="amount-sign">{{ getAmountPrefix(transaction.type) }}</span>{{ formatCurrency(transaction.amount) }}
          </p>
        </ion-item>
      </ion-list>
    </ng-container>
  </section>

</ion-content>

<ion-modal [isOpen]="isReportsModalOpen" (didDismiss)="closeReportsModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Monthly Reports</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeReportsModal()">Close</ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content>
      <ion-list lines="full">
        <ion-item *ngFor="let report of monthlyReports">
          <ion-label>
            <h3>{{ formatReportMonth(report.month) }}</h3>
            <p>Income: {{ formatCurrency(+report.total_income) }}</p>
            <p>Expenses: {{ formatCurrency(+report.total_expenses) }}</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </ion-content>
  </ng-template>
</ion-modal>
