<ion-header [translucent]="true" class="app-header">
  <ion-toolbar>
    <ion-title>Home</ion-title>
    <ion-buttons slot="end">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="false" class="dashboard app-content">
  <div class="page page-shell">
    <div class="home-actions-row">
      <ion-searchbar
        class="tx-search"
        mode="ios"
        placeholder="Search transaction"
        [value]="searchTerm"
        (ionInput)="onSearchChange($event)"
        show-clear-button="focus"
      ></ion-searchbar>

      <button class="notification-btn" type="button" (click)="openNotifications()" aria-label="Notifications">
        <ion-icon name="notifications-outline"></ion-icon>
        <span class="notification-badge" *ngIf="notificationCount > 0">{{ notificationCount }}</span>
      </button>
    </div>

    <div class="month-summary-card">
      <div class="section-top-row">
        <div class="small-label">Total Balance</div>
        <ion-icon name="wallet-outline"></ion-icon>
      </div>
      <div class="total-value">{{ formatCurrency(totalWalletBalance) }}</div>

      <div class="month-inline-summary">
        <span>{{ monthLabel }}</span>
        <span>{{ totalTransaction }} transactions</span>
      </div>
    </div>

    <div class="section-header">
      <div class="section-title">My Wallets</div>
      <button type="button" class="section-link" (click)="openWallets()">See All</button>
    </div>

    <div class="wallet-list" *ngIf="!isLoadingDashboard && jars.length > 0; else walletState">
      <button
        type="button"
        class="wallet-card"
        *ngFor="let jar of jars; let i = index; trackBy: trackByWalletId"
        (click)="openWalletDetail()"
      >
        <div class="wallet-head">
          <div class="wallet-icon" [class.alt]="i % 2 === 1">
            <ion-icon [name]="i % 2 === 0 ? 'wallet-outline' : 'card-outline'"></ion-icon>
          </div>
          <div class="wallet-name">{{ jar.name }}</div>
        </div>
        <div class="wallet-balance">{{ formatCurrency(jar.balance) }}</div>
        <div class="wallet-progress">
          <span [style.width.%]="getWalletProgress(jar)"></span>
        </div>
      </button>
    </div>
    <ng-template #walletState>
      <div class="loading-state" *ngIf="isLoadingDashboard">
        <ion-spinner name="crescent"></ion-spinner>
        <span>Loading wallets...</span>
      </div>
      <div class="empty-card" *ngIf="!isLoadingDashboard">No wallets yet.</div>
    </ng-template>

    <div class="section-header">
      <div class="section-title">Top spending</div>
    </div>

    <div class="spending-tabs">
      <button
        type="button"
        class="spending-tab"
        [class.active]="selectedSpendingTab === 'week'"
        (click)="selectSpendingTab('week')"
      >
        Week
      </button>
      <button
        type="button"
        class="spending-tab"
        [class.active]="selectedSpendingTab === 'month'"
        (click)="selectSpendingTab('month')"
      >
        Month
      </button>
    </div>

    <div class="loading-state" *ngIf="isLoadingDashboard">
      <ion-spinner name="crescent"></ion-spinner>
      <span>Loading spending summary...</span>
    </div>

    <div class="top-spending-grid" *ngIf="!isLoadingDashboard">
      <div class="spending-card" *ngIf="selectedSpendingTab === 'week'; else monthSpending">
        <div class="spending-label">This week</div>
        <div
          class="spending-item"
          *ngFor="let item of weeklyTopSpending | slice : 0 : 3"
        >
          <div class="spending-item-left">
            <div class="spending-title">{{ item.title }}</div>
            <div class="spending-value">{{ formatCurrency(item.amount) }}</div>
          </div>
          <div class="spending-item-right">
            <div class="spending-percent">
              {{ item.percentage | number: '1.0-0' }}%
            </div>
          </div>
        </div>
      </div>

      <ng-template #monthSpending>
        <div class="spending-card">
          <div class="spending-label">This month</div>
          <div
            class="spending-item"
            *ngFor="let item of monthlyTopSpending | slice : 0 : 3"
          >
            <div class="spending-item-left">
              <div class="spending-title">{{ item.title }}</div>
              <div class="spending-value">{{ formatCurrency(item.amount) }}</div>
            </div>
            <div class="spending-item-right">
              <div class="spending-percent">
                {{ item.percentage | number: '1.0-0' }}%
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </div>

    <div class="section-header">
      <div class="section-title">Report this month</div>
    </div>

    <div class="report-tabs">
      <button
        type="button"
        class="report-tab"
        [class.active]="reportMetricTab === 'expense'"
        (click)="selectReportMetricTab('expense')"
      >
        Total spent
      </button>
      <button
        type="button"
        class="report-tab"
        [class.active]="reportMetricTab === 'income'"
        (click)="selectReportMetricTab('income')"
      >
        Total income
      </button>
    </div>

    <div class="report-tabs secondary">
      <button
        type="button"
        class="report-tab"
        [class.active]="reportRangeTab === 'week'"
        (click)="selectReportRangeTab('week')"
      >
        Week
      </button>
      <button
        type="button"
        class="report-tab"
        [class.active]="reportRangeTab === 'month'"
        (click)="selectReportRangeTab('month')"
      >
        Month
      </button>
    </div>

    <div class="report-card" *ngIf="!isLoadingDashboard; else reportLoading">
      <div class="report-chart-line">
        <svg viewBox="0 0 300 160" preserveAspectRatio="none">
          <g class="grid-lines">
            <line x1="16" y1="20" x2="284" y2="20"></line>
            <line x1="16" y1="80" x2="284" y2="80"></line>
            <line x1="16" y1="140" x2="284" y2="140"></line>
          </g>

          <path
            [ngClass]="reportMetricTab === 'income' ? 'income-line' : 'expense-line'"
            [attr.d]="reportPath"
          ></path>

          <polyline
            [ngClass]="reportMetricTab === 'income' ? 'income-points' : 'expense-points'"
            [attr.points]="reportPoints"
          ></polyline>

          <ng-container *ngFor="let tick of reportAxisTicks">
            <text
              class="chart-axis-value"
              x="294"
              [attr.y]="tick.y"
            >
              {{ formatAxisValue(tick.value) }}
            </text>
          </ng-container>

          <ng-container *ngFor="let label of reportLabels; let index = index">
            <rect
              class="chart-hit-area"
              [attr.x]="getReportHitAreaX(index)"
              y="14"
              width="24"
              height="132"
              (click)="selectReportPoint(index)"
            ></rect>
          </ng-container>
        </svg>
      </div>

      <div class="chart-legend">
        <div class="legend-item">
          <span
            class="legend-dot"
            [class.income]="reportMetricTab === 'income'"
            [class.expense]="reportMetricTab === 'expense'"
          ></span>
          <span>{{ reportMetricTab === 'income' ? 'Total income' : 'Total spent' }}</span>
          <strong>{{ formatCurrency(reportTotal) }}</strong>
        </div>

        <div class="legend-item" *ngIf="getActiveReportLabel() && getActiveReportValue() !== null">
          <span class="legend-dot detail"></span>
          <span>{{ getActiveReportLabel() }}</span>
          <strong>{{ formatCurrency(getActiveReportValue()) }}</strong>
        </div>
      </div>

      <div class="chart-labels" *ngIf="reportLabels.length > 0">
        <span *ngFor="let label of reportLabels">{{ label }}</span>
      </div>
    </div>
    <ng-template #reportLoading>
      <div class="loading-state">
        <ion-spinner name="crescent"></ion-spinner>
        <span>Loading report...</span>
      </div>
    </ng-template>

    <div class="section-header">
      <div class="section-title">Recent transactions</div>
      <div class="tx-count">{{ filteredTransactions.length }}</div>
    </div>

    <div class="loading-state" *ngIf="isLoadingDashboard">
      <ion-spinner name="crescent"></ion-spinner>
      <span>Loading transactions...</span>
    </div>

    <div class="transaction-list" *ngIf="!isLoadingDashboard && filteredTransactions.length > 0; else emptyTransactions">
      <div
        class="transaction-card"
        *ngFor="let tx of filteredTransactions; trackBy: trackByTransactionId"
        (click)="openTransactionDetail(tx)"
      >
        <div class="tx-icon" [class.income]="tx.type === 'income'" [class.expense]="tx.type === 'expense'">
          <ion-icon [name]="tx.icon"></ion-icon>
        </div>
        <div class="tx-meta">
          <div class="tx-title">{{ tx.title }}</div>
          <div class="tx-sub">{{ tx.jarName }} â€¢ {{ tx.timeLabel }}</div>
        </div>
        <div class="tx-amount" [class.income]="tx.type === 'income'" [class.expense]="tx.type === 'expense'">
          {{ formatCurrency(tx.amount) }}
        </div>
      </div>
    </div>
    <ng-template #emptyTransactions>
      <div class="empty-card" *ngIf="!isLoadingDashboard">No transactions match your search.</div>
    </ng-template>
  </div>

</ion-content>
